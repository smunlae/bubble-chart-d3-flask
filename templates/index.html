<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gift Bubbles</title>
  <style>
    body { margin: 0; font-family: sans-serif; background: #333; color: #fff; }
    #chart { display: block; margin: auto; }
    .bubble-text { pointer-events: none; text-anchor: middle; fill: #fff; dominant-baseline: middle; }
  </style>
</head>
<body>
  <svg id="chart" viewBox="0 0 800 600" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></svg>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    async function loadData() {
      const resp = await fetch('/data');
      const json = await resp.json();
      return Object.entries(json).map(([name, change]) => ({ name, change }));
    }

    async function drawChart() {
      const data = await loadData();
      const width = 800, height = 600;
      const svg = d3.select('#chart');
      const root = d3.pack().size([width, height]).padding(8)(
        d3.hierarchy({ children: data }).sum(d => Math.abs(d.change) * 2)
      );

      const node = svg.selectAll('g').data(root.leaves()).join('g')
        .attr('transform', d => `translate(${d.x},${d.y})`);

      node.append('circle').attr('r', d => d.r).attr('fill', d => d.data.change >= 0 ? '#3cb371' : '#dc143c').attr('opacity', 0.8);

      // Добавляем текст и динамически подбираем размер шрифта
      node.append('text').attr('class', 'bubble-text')
        .each(function(d) {
          const group = d3.select(this);
          const lines = [d.data.name, d.data.change.toFixed(2) + '%'];
          let fontSize = d.r * 0.3; // начальный
          group.style('font-size', fontSize + 'px');
          group.selectAll('tspan').data(lines).join('tspan')
            .attr('x', 0)
            .attr('dy', (ln, i) => i * 1.2 + 'em')
            .text(ln => ln);

          // Измеряем bbox текста
          let bbox = group.node().getBBox();
          // Пока текст выходит за круг, уменьшаем fontSize
          while ((bbox.width > d.r * 1.8 || bbox.height > d.r * 1.8) && fontSize > 6) {
            fontSize -= 1;
            group.style('font-size', fontSize + 'px');
            bbox = group.node().getBBox();
          }
          // После уменьшения центрируем вертикально
          const shiftY = -((bbox.height - parseFloat(group.style('font-size'))) / 2);
          group.attr('transform', `translate(0, ${shiftY})`);
        });
    }

    drawChart();
  </script>
</body>
</html>
