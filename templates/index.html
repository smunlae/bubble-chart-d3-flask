<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gift Bubbles</title>
  <style>
    body { margin: 0; font-family: sans-serif; background: #111; color: #fff; }
    #chart { display: block; margin: auto; }
    .bubble-text { pointer-events: none; text-anchor: middle; fill: #fff; dominant-baseline: middle; }
  </style>
</head>
<body>
  <svg id="chart" viewBox="0 0 800 600" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></svg>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    async function loadData() {
      const resp = await fetch('/data');
      const json = await resp.json();
      return Object.entries(json).map(([name, change]) => ({ name, change }));
    }

    async function drawChart() {
      const data = await loadData();
      const width = 800, height = 600;
      const svg = d3.select('#chart');

      // Общий defs для clipPath
      const defs = svg.append('defs');

      const root = d3.pack().size([width, height]).padding(8)(
        d3.hierarchy({ children: data }).sum(d => Math.abs(d.change) * 2)
      );

      const nodes = svg.selectAll('g').data(root.leaves()).join('g')
        .attr('transform', d => `translate(${d.x},${d.y})`);

      nodes.each(function(d, i) {
        const group = d3.select(this);
        const r = d.r;
        // Увеличиваем диаметр заливки на 7%
        const oversize = 1.07;
        const size = r * 2 * oversize;
        const url = d.data.change >= 0 ? '/static/green_bubble.png' : '/static/red_bubble.png';
        const clipId = `clip-${i}`;

        // Создаем clipPath с кругом (радиус r)
        defs.append('clipPath').attr('id', clipId)
          .append('circle').attr('r', r);

        // Изображение с обрезкой по clipPath и увеличенным размером
        group.append('image')
          .attr('href', url)
          .attr('x', -size / 2)
          .attr('y', -size / 2)
          .attr('width', size)
          .attr('height', size)
          .attr('preserveAspectRatio', 'xMidYMid slice')
          .attr('clip-path', `url(#${clipId})`);

        // Обводка круга
        group.append('circle')
          .attr('r', r)
          .attr('fill', 'none')
          .attr('stroke', d.data.change >= 0 ? '#3cb371' : '#dc143c')
          .attr('stroke-width', 2);
      });

      // Текст внутри пузыря
      nodes.append('text').attr('class', 'bubble-text')
        .each(function(d) {
          const group = d3.select(this);
          const lines = [d.data.name, d.data.change.toFixed(2) + '%'];
          let fontSize = d.r * 0.3;
          group.style('font-size', fontSize + 'px');
          group.selectAll('tspan').data(lines).join('tspan')
            .attr('x', 0)
            .attr('dy', (ln, i) => i * 1.2 + 'em')
            .text(ln => ln);

          let bbox = group.node().getBBox();
          while ((bbox.width > d.r * 1.8 || bbox.height > d.r * 1.8) && fontSize > 6) {
            fontSize -= 1;
            group.style('font-size', fontSize + 'px');
            bbox = group.node().getBBox();
          }
          const shiftY = -((bbox.height - parseFloat(group.style('font-size'))) / 2);
          group.attr('transform', `translate(0, ${shiftY})`);
        });
    }

    drawChart();
  </script>
</body>
</html>
